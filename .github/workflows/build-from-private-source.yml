name: Build from Private Source

on:
  repository_dispatch:
    types: [trigger-build] 
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Private Repo
        uses: actions/checkout@v4
        with:
          repository: ErikYu/little-things
          token: ${{ secrets.ACCESS_TOKEN }}
          path: private-source
          ref: main 

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10
          run_install: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'
          # 【重要】因为代码在 private-source 子目录下，必须指定 lock 文件位置
          # 否则 setup-node 找不到 pnpm-lock.yaml 会导致缓存失败
          cache-dependency-path: private-source/pnpm-lock.yaml

      # 4. 构建
      - name: Install and Build
        run: |
          cd private-source
          pnpm install
          pnpm prisma:generate
          pnpm run build
        # 构建产物通常在 private-source/dist (取决于你的项目配置)

      # 5. 打包构建产物
      - name: Package Build Artifacts
        run: |
          cd private-source
          tar -czf build-artifacts.tar.gz \
            package.json \
            pnpm-lock.yaml \
            prisma.config.ts \
            prisma/ \
            dist/

      # 6. 上传构建产物到 GitHub Artifacts (可选，用于备份)
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: private-source/build-artifacts.tar.gz
          retention-days: 30

      # 7. 配置 SSH
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ECS_SSH_KEY }}

      # 8. 部署到阿里云 ECS
      - name: Deploy to Alibaba Cloud ECS
        env:
          ECS_HOST: ${{ secrets.ECS_HOST }}
          ECS_USER: ${{ secrets.ECS_USER }}
          ECS_DEPLOY_PATH: ${{ secrets.ECS_DEPLOY_PATH || '/tmp' }}
        run: |
          # 上传打包文件到 ECS
          scp -o StrictHostKeyChecking=no \
            private-source/build-artifacts.tar.gz \
            ${ECS_USER}@${ECS_HOST}:${ECS_DEPLOY_PATH}/build-artifacts.tar.gz
          
          # 在 ECS 上解压并部署
          # 使用 bash -l 启动登录 shell，自动加载所有环境变量（包括 ~/.bashrc）
          ssh -o StrictHostKeyChecking=no ${ECS_USER}@${ECS_HOST} bash -l << EOF
            set -e
            
            # 显式加载 bashrc（确保环境变量已加载）
            if [ -f ~/.bashrc ]; then
              source ~/.bashrc
            fi
            if [ -f ~/.bash_profile ]; then
              source ~/.bash_profile
            fi
            if [ -f ~/.profile ]; then
              source ~/.profile
            fi
            
            # 验证环境
            echo "=== Environment Check ==="
            echo "Node version: \$(node -v)"
            echo "npm version: \$(npm -v)"
            echo "PATH: \$PATH"
            echo "pnpm path: \$(which pnpm || echo 'pnpm not found in PATH')"
            
            # 检查 pnpm 是否可用
            if ! command -v pnpm &> /dev/null; then
              echo "❌ Error: pnpm command not found!"
              echo "Please ensure pnpm is installed and added to PATH in ~/.bashrc"
              exit 1
            fi
            
            echo "pnpm version: \$(pnpm -v)"
            echo "=== Environment Check Complete ==="
            
            cd ${ECS_DEPLOY_PATH}
            
            # 部署到临时目录，避免影响正在运行的服务
            DEPLOY_TEMP="app.new.\$(date +%Y%m%d_%H%M%S)"
            mkdir -p "\$DEPLOY_TEMP"
            cd "\$DEPLOY_TEMP"
            
            # 解压构建产物（文件在上级目录）
            tar -xzf ../build-artifacts.tar.gz
            
            # 清理临时文件
            rm -f ../build-artifacts.tar.gz

            cp ../.env .env
            cp ../ecosystem.config.js ./ecosystem.config.js
            
            # 安装生产依赖
            echo "Installing production dependencies..."
            pnpm install
            
            # 运行数据库迁移
            echo "Running database migration..."
            pnpm prisma migrate deploy
            
            # 回到部署目录
            cd ${ECS_DEPLOY_PATH}
            
            # 备份旧版本（排除 node_modules），仅在存在时备份
            if [ -d "app" ]; then
              BACKUP_NAME="app.backup.\$(date +%Y%m%d_%H%M%S)"
              mkdir -p "\$BACKUP_NAME"
              # 使用 rsync 复制，排除 node_modules
              rsync -av --exclude='node_modules' --exclude='.pnpm-store' app/ "\$BACKUP_NAME/"
              echo "✅ Backup created: \$BACKUP_NAME (excluding node_modules)"
            fi
            
            # 原子性切换：重命名旧目录（如果存在），然后重命名新目录为 app
            if [ -d "app" ]; then
              mv app app.old.\$(date +%Y%m%d_%H%M%S)
            fi
            mv "\$DEPLOY_TEMP" app
            
            cd app
            pm2 startOrGracefulReload -a ./ecosystem.config.js
            
            # 清理旧的临时目录（保留最新的几个备份）
            cd ${ECS_DEPLOY_PATH}
            ls -dt app.old.* 2>/dev/null | tail -n +4 | xargs rm -rf 2>/dev/null || true
            ls -dt app.backup.* 2>/dev/null | tail -n +4 | xargs rm -rf 2>/dev/null || true
          EOF
