// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AdminUser {
  id            String   @id @default(cuid())
  username      String   @unique
  password      String
  created_at    DateTime @default(now())
  last_login_at DateTime @default(now())

  @@map("admin_users")
}

model User {
  id            String   @id @default(cuid())
  apple_id      String?  @unique
  email         String?  @unique
  password      String?
  created_at    DateTime @default(now())
  last_login_at DateTime @default(now())
  device_token  String?

  answers            Answer[]
  QuestionUserPinned QuestionUserPinned[]
  apnhistories       APNHistory[]

  @@map("users")
}

model Category {
  id         String   @id @default(cuid())
  name       String
  sequence   Int
  parent_id  String?
  created_at DateTime @default(now()) // 上传时间
  updated_at DateTime @updatedAt // 更新时间

  parent        Category?  @relation("CategoryToChildren", fields: [parent_id], references: [id], onDelete: SetNull)
  children      Category[] @relation("CategoryToChildren")
  questions     Question[] @relation("QuestionCategory")
  sub_questions Question[] @relation("QuestionSubCategory")

  @@unique([parent_id, name])
  @@index([parent_id])
  @@map("categories")
}

model Question {
  id              String    @id @default(cuid())
  title           String
  category_id     String
  sub_category_id String?
  cluster         String?
  sequence        Int
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  deleted_at      DateTime?

  category           Category             @relation("QuestionCategory", fields: [category_id], references: [id])
  sub_category       Category?            @relation("QuestionSubCategory", fields: [sub_category_id], references: [id], onDelete: SetNull)
  answers            Answer[]
  QuestionUserPinned QuestionUserPinned[]
  QuestionOfTheDay   QuestionOfTheDay?

  @@map("questions")
}

model QuestionUserPinned {
  id          String @id @default(cuid())
  question_id String
  user_id     String

  created_at DateTime @default(now())

  question Question @relation(fields: [question_id], references: [id])
  user     User     @relation(fields: [user_id], references: [id])

  @@map("question_user_pinned")
}

model Answer {
  id                String   @id @default(cuid())
  sequence          Int      @unique @default(autoincrement())
  content           String
  user_id           String
  question_id       String
  question_snapshot String
  created_ymd       String // 年月日
  created_tms       String // 年月日时分秒
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  user     User        @relation(fields: [user_id], references: [id])
  question Question    @relation(fields: [question_id], references: [id])
  icon     AnswerIcon?

  @@map("answers")
}

enum AnswerIconStatus {
  PENDING
  GENERATED
  FAILED
}

enum PromptTestIconStatus {
  PENDING
  GENERATED
  FAILED
}

model AnswerIcon {
  id                String           @id @default(cuid())
  answer_id         String           @unique
  url               String
  status            AnswerIconStatus
  created_at        DateTime         @default(now())
  updated_at        DateTime         @updatedAt
  error             String?
  bypass            Boolean          @default(false)
  prompt_version_id String?

  answer         Answer         @relation(fields: [answer_id], references: [id])
  prompt_version PromptVersion? @relation(fields: [prompt_version_id], references: [id], onDelete: SetNull)

  @@index([prompt_version_id])
  @@map("answer_icons")
}

enum PromptCategory {
  ICON_GENERATION
}

model Prompt {
  id                 String         @id @default(cuid())
  category           PromptCategory
  content            String
  active             Boolean
  created_at         DateTime       @default(now())
  updated_at         DateTime       @updatedAt
  deleted_at         DateTime?
  current_version_id String?        @unique

  current_version PromptVersion?  @relation("CurrentVersion", fields: [current_version_id], references: [id], onDelete: SetNull)
  versions        PromptVersion[]

  @@map("prompts")
}

model PromptVersion {
  id          String   @id @default(cuid())
  prompt_id   String
  version     Int
  content     String
  created_by  String?
  created_at  DateTime @default(now())
  change_note String?

  prompt        Prompt           @relation(fields: [prompt_id], references: [id], onDelete: Cascade)
  currentPrompt Prompt?          @relation("CurrentVersion")
  answer_icons  AnswerIcon[]
  test_icons    PromptTestIcon[]

  @@unique([prompt_id, version])
  @@index([prompt_id])
  @@index([prompt_id, version])
  @@map("prompt_versions")
}

enum APNHistoryStatus {
  PENDING
  SENT
  FAILED
}

model PromptTestIcon {
  id                String               @id @default(cuid())
  prompt_version_id String
  test_input        String
  url               String
  status            PromptTestIconStatus @default(PENDING)
  created_at        DateTime             @default(now())
  updated_at        DateTime             @updatedAt
  error             String?
  created_by        String?
  test_note         String?

  prompt_version PromptVersion @relation(fields: [prompt_version_id], references: [id], onDelete: Cascade)

  @@index([prompt_version_id])
  @@index([prompt_version_id, status])
  @@map("prompt_test_icons")
}

model APNHistory {
  id           String           @id @default(cuid())
  user_id      String
  device_token String
  title        String?
  subtitle     String?
  body         String?
  topic        String?
  status       APNHistoryStatus
  error        String?
  created_at   DateTime         @default(now())
  updated_at   DateTime         @updatedAt

  user User @relation(fields: [user_id], references: [id])

  @@map("apn_histories")
}

model QuestionOfTheDay {
  id          String   @id @default(cuid())
  question_id String
  sequence    Int // 排序字段，1-3
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  question Question @relation(fields: [question_id], references: [id], onDelete: Cascade)

  @@unique([question_id])
  @@unique([sequence])
  @@index([sequence])
  @@map("question_of_the_day")
}
